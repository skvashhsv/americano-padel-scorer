<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Americano Padel Tournament</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            --transition: all 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.4;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 24px;
            color: white;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Top Row - Registration and Tournament Control */
        .top-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            height: 100%;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 0.85rem;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: var(--transition);
            background: white;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Players List */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .player-card {
            background: white;
            border-radius: 6px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--gray-light);
            font-size: 0.85rem;
        }

        .player-name {
            font-weight: 600;
            color: var(--dark);
        }

        .player-number {
            background: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
        }

        /* –ú–∞—Ç—á–∏ —Å —Ç—É—Ä–∞–º–∏ */
        .tour-container {
            margin-bottom: 20px;
        }

        .tour-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tour-title {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tour-court {
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .matches-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }

        .match-card {
            background: white;
            border-radius: var(--radius);
            padding: 12px;
            border: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .match-card.completed {
            border-color: var(--secondary);
            background: #f0fdf4;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-light);
        }

        .match-id {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary);
            background: #e0e7ff;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .match-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .status-completed {
            background: #d1fae5;
            color: var(--secondary);
        }

        /* –£–ª—å—Ç—Ä–∞–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ */
        .match-teams-compact {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .team-compact {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .team-player-compact {
            padding: 6px 8px;
            border-radius: 4px;
            background: #f8fafc;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.8rem;
        }

        .vs-compact {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.8rem;
            text-align: center;
        }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å—á–µ—Ç–∞ */
        .score-inputs-compact {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
        }

        .score-input-compact {
            text-align: center;
            padding: 6px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 700;
            width: 100%;
            transition: var(--transition);
            background: white;
        }

        .score-input-compact:focus {
            border-color: var(--primary);
            outline: none;
        }

        .score-separator-compact {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--dark);
            text-align: center;
        }

        .match-actions {
            display: flex;
            gap: 6px;
        }

        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 12px;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 0.8rem;
        }

        .results-table th {
            background: var(--primary);
            color: white;
            font-weight: 700;
            padding: 10px 8px;
            text-align: center;
            font-size: 0.8rem;
        }

        .results-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid var(--gray-light);
        }

        .results-table .winner {
            background: #d1fae5;
            font-weight: 700;
        }

        .positive {
            color: var(--secondary);
            font-weight: 700;
        }

        .negative {
            color: var(--danger);
        }

        /* Tournament Info */
        .tournament-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .info-card {
            background: var(--primary);
            color: white;
            padding: 12px;
            border-radius: var(--radius);
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }

        .info-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .stat-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
            margin: 3px 0;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            margin: 1px;
        }

        .badge-primary {
            background: #e0e7ff;
            color: var(--primary);
        }

        .badge-court {
            background: #fef3c7;
            color: #92400e;
        }

        /* Modal for Match Editing */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 16px;
            text-align: center;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 20px;
            color: white;
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Error Message */
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            display: none;
        }

        /* Court Colors */
        .court-1 { border-left: 3px solid #6366f1; }
        .court-2 { border-left: 3px solid #10b981; }
        .court-3 { border-left: 3px solid #f59e0b; }
        .court-4 { border-left: 3px solid #8b5cf6; }
        .court-5 { border-left: 3px solid #ec4899; }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .top-row {
                grid-template-columns: 1fr;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .matches-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üéæ Americano Padel</h1>
            <p>–¢—É—Ä–Ω–∏—Ä —Å —Ä–∞–≤–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∞—Ç—á–µ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ—Ä—Ç–æ–≤</p>
        </div>

        <!-- Top Row: Registration and Tournament Control -->
        <div class="top-row">
            <!-- Registration Card -->
            <div class="card">
                <h2 class="card-title">üë• –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–æ–≤</h2>
                <div class="form-group">
                    <input type="text" id="playerName" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞" autocomplete="off">
                </div>
                <button onclick="addPlayer()" class="btn btn-primary" style="width: 100%">
                    –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞
                </button>

                <h3 style="margin-top: 16px; margin-bottom: 8px; color: var(--dark); font-size: 0.9rem;">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: <span id="playersCount">0</span> –∏–≥—Ä–æ–∫–æ–≤
                </h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalMatchesCalc">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –º–∞—Ç—á–µ–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="matchesPerPlayer">0</div>
                        <div class="stat-label">–ú–∞—Ç—á–µ–π –Ω–∞ –∏–≥—Ä–æ–∫–∞</div>
                    </div>
                </div>
                
                <div id="playersList" class="players-grid"></div>
                
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <button onclick="clearPlayers()" class="btn btn-danger" style="flex: 1;">
                        –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
            </div>

            <!-- Tournament Control -->
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–æ–º</h2>
                
                <div id="tournamentStatus" style="
                    background: #fef3c7;
                    padding: 10px;
                    border-radius: 6px;
                    margin-bottom: 12px;
                    text-align: center;
                    border: 1px solid #f59e0b;
                    font-size: 0.85rem;
                ">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 4px;">
                        ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    </div>
                    <div style="color: #92400e;">
                        –î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä—Ç–æ–≤</label>
                    <select id="courtCount" class="form-select">
                        <option value="1">1 –∫–æ—Ä—Ç</option>
                        <option value="2">2 –∫–æ—Ä—Ç–∞</option>
                        <option value="3">3 –∫–æ—Ä—Ç–∞</option>
                        <option value="4">4 –∫–æ—Ä—Ç–∞</option>
                        <option value="5">5 –∫–æ—Ä—Ç–æ–≤</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button onclick="startTournament()" id="startBtn" class="btn btn-success" style="flex: 1;" disabled>
                        üèÅ –ù–∞—á–∞—Ç—å —Ç—É—Ä–Ω–∏—Ä
                    </button>
                    <button onclick="resetTournament()" class="btn btn-danger" style="flex: 1;">
                        üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä
                    </button>
                </div>

                <div class="tournament-info">
                    <div class="info-card">
                        <div class="info-value" id="matchesPlayed">0</div>
                        <div class="info-label">–°—ã–≥—Ä–∞–Ω–æ</div>
                    </div>
                    <div class="info-card">
                        <div class="info-value" id="matchesTotal">0</div>
                        <div class="info-label">–í—Å–µ–≥–æ</div>
                    </div>
                    <div class="info-card">
                        <div class="info-value" id="courtsCount">1</div>
                        <div class="info-label">–ö–æ—Ä—Ç–æ–≤</div>
                    </div>
                </div>

                <div id="tourInfo" style="margin-top: 12px; font-size: 0.85rem; color: var(--gray);"></div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid">
            <!-- Current Scores -->
            <div class="card grid-full">
                <h2 class="card-title">üèÜ –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏</h2>
                <div id="currentScores" class="tournament-info"></div>
            </div>

            <!-- Matches with Tours -->
            <div class="card grid-full">
                <h2 class="card-title">üìÖ –°–µ—Ç–∫–∞ –º–∞—Ç—á–µ–π –ø–æ —Ç—É—Ä–∞–º</h2>
                <div id="matchesGrid">
                    <div class="loading">
                        –ú–∞—Ç—á–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="card grid-full">
                <h2 class="card-title">üìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
                <div style="overflow-x: auto;">
                    <table id="resultsTable" class="results-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ò–≥—Ä–æ–∫</th>
                                <th>–ú–∞—Ç—á–∏</th>
                                <th>–û—á–∫–∏</th>
                                <th>+/- –≥–µ–π–º—ã</th>
                                <th>–ü–∞—Ä—Ç–Ω–µ—Ä—ã</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                                    –ò—Ç–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Americano Padel Tournament ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ—Ä—Ç–æ–≤ –∏ —Ç—É—Ä–Ω–∏—Ä–Ω—ã—Ö —Ç—É—Ä–æ–≤</p>
        </div>
    </div>

    <!-- Modal for Editing Match -->
    <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç—á</div>
            <div id="modalContent"></div>
            <div id="modalError" class="error-message"></div>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button onclick="saveEditedMatch()" class="btn btn-success" style="flex: 1;">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button onclick="closeEditModal()" class="btn btn-outline" style="flex: 1;">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä–∞
        let players = [];
        let matches = [];
        let tournamentStarted = false;
        let editingMatchId = null;
        let courtCount = 1;
        
        // –†–∞—Å—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—Ç—á–µ–π
        function calculateOptimalMatches() {
            if (players.length < 4) return { total: 0, perPlayer: 0 };
            
            const n = players.length;
            let matchesPerPlayer = 0;
            let totalMatches = 0;
            
            if (n === 4) {
                matchesPerPlayer = 3;
                totalMatches = 3;
            } else if (n === 5) {
                matchesPerPlayer = 4;
                totalMatches = 5;
            } else if (n === 6) {
                matchesPerPlayer = 5;
                totalMatches = 8;
            } else if (n === 7) {
                matchesPerPlayer = 6;
                totalMatches = 11;
            } else if (n === 8) {
                matchesPerPlayer = 7;
                totalMatches = 14;
            } else if (n >= 9) {
                matchesPerPlayer = Math.min(8, Math.floor((n - 1) * 3 / 4));
                totalMatches = Math.ceil(matchesPerPlayer * n / 4);
            }
            
            return { total: totalMatches, perPlayer: matchesPerPlayer };
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ç—á–µ–π —Å —É—á–µ—Ç–æ–º –∫–æ—Ä—Ç–æ–≤ –∏ —Ç—É—Ä–æ–≤
        function generateBalancedMatchesWithTours() {
            matches = [];
            
            if (players.length < 4) return;
            
            const n = players.length;
            const optimal = calculateOptimalMatches();
            const totalMatches = optimal.total;
            const targetMatchesPerPlayer = optimal.perPlayer;
            courtCount = parseInt(document.getElementById('courtCount').value) || 1;
            
            // –ú–∞—Ç—Ä–∏—Ü–∞ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–µ
            const playedTogether = {};
            players.forEach(p1 => {
                playedTogether[p1.id] = {};
                players.forEach(p2 => {
                    if (p1.id !== p2.id) {
                        playedTogether[p1.id][p2.id] = 0;
                    }
                });
            });
            
            // –°—á–µ—Ç—á–∏–∫ –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            const matchCount = {};
            // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Ç—É—Ä–∞–º (—á—Ç–æ–±—ã –Ω–µ –∏–≥—Ä–∞–ª–∏ –≤ –æ–¥–Ω–æ–º —Ç—É—Ä–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∫–æ—Ä—Ç–∞—Ö)
            const playerTourSchedule = {};
            players.forEach(p => {
                matchCount[p.id] = 0;
                playerTourSchedule[p.id] = [];
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—É—á—à–µ–≥–æ –º–∞—Ç—á–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç—É—Ä–∞
            function findBestMatchForTour(tour, court) {
                let bestMatch = null;
                let bestScore = -Infinity;
                
                // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                for (let attempt = 0; attempt < 100; attempt++) {
                    // –í—ã–±–∏—Ä–∞–µ–º 4 —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞
                    const shuffled = [...players].sort(() => Math.random() - 0.5);
                    const quad = shuffled.slice(0, 4).map(p => p.id);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∏ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ –Ω–µ –∑–∞–Ω—è—Ç –≤ —ç—Ç–æ–º —Ç—É—Ä–µ
                    const busyInTour = quad.some(playerId => 
                        playerTourSchedule[playerId].includes(tour)
                    );
                    
                    if (busyInTour) continue;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
                    const options = [
                        { team1: [quad[0], quad[1]], team2: [quad[2], quad[3]] },
                        { team1: [quad[0], quad[2]], team2: [quad[1], quad[3]] },
                        { team1: [quad[0], quad[3]], team2: [quad[1], quad[2]] }
                    ];
                    
                    for (const option of options) {
                        // –í—ã—á–∏—Å–ª—è–µ–º "—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å" —ç—Ç–æ–≥–æ –º–∞—Ç—á–∞
                        let score = 0;
                        
                        // 1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–≥—Ä–æ–∫–∞–º —Å –º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∞—Ç—á–µ–π
                        const playersInMatch = [...option.team1, ...option.team2];
                        const avgMatches = playersInMatch.reduce((sum, id) => sum + matchCount[id], 0) / 4;
                        
                        playersInMatch.forEach(id => {
                            const diff = matchCount[id] - avgMatches;
                            score -= Math.abs(diff) * 100;
                        });
                        
                        // 2. –®—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ä—ã
                        score -= playedTogether[option.team1[0]][option.team1[1]] * 50;
                        score -= playedTogether[option.team2[0]][option.team2[1]] * 50;
                        
                        // 3. –ë–æ–Ω—É—Å –∑–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ
                        const pair1New = playedTogether[option.team1[0]][option.team1[1]] === 0 ? 20 : 0;
                        const pair2New = playedTogether[option.team2[0]][option.team2[1]] === 0 ? 20 : 0;
                        score += pair1New + pair2New;
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = option;
                        }
                    }
                }
                
                return bestMatch;
            }
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ç—á–∏ –ø–æ —Ç—É—Ä–∞–º –∏ –∫–æ—Ä—Ç–∞–º
            let matchId = 1;
            let tour = 1;
            const matchesPerTour = courtCount;
            
            while (matchId <= totalMatches) {
                // –°–æ–±–∏—Ä–∞–µ–º –º–∞—Ç—á–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç—É—Ä–∞
                const tourMatches = [];
                
                for (let court = 1; court <= courtCount && matchId <= totalMatches; court++) {
                    const match = findBestMatchForTour(tour, court);
                    
                    if (match) {
                        // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç—É—Ä–µ –∏ –∫–æ—Ä—Ç–µ
                        const matchData = {
                            id: matchId,
                            team1: match.team1,
                            team2: match.team2,
                            score1: '',
                            score2: '',
                            completed: false,
                            tour: tour,
                            court: court
                        };
                        
                        tourMatches.push(matchData);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        [...match.team1, ...match.team2].forEach(playerId => {
                            matchCount[playerId]++;
                            playerTourSchedule[playerId].push(tour);
                        });
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—Ä–∏—Ü—É —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–µ
                        playedTogether[match.team1[0]][match.team1[1]]++;
                        playedTogether[match.team1[1]][match.team1[0]]++;
                        playedTogether[match.team2[0]][match.team2[1]]++;
                        playedTogether[match.team2[1]][match.team2[0]]++;
                        
                        matchId++;
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ç—á–∏ —Ç—É—Ä–∞ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
                matches.push(...tourMatches);
                tour++;
                
                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Ç—á–∏ –¥–ª—è —Ç—É—Ä–∞, –≤—ã—Ö–æ–¥–∏–º
                if (tourMatches.length === 0) break;
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–∞
            const minMatches = Math.min(...Object.values(matchCount));
            const maxMatches = Math.max(...Object.values(matchCount));
            
            if (maxMatches - minMatches > 1) {
                console.log("–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ...");
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ç—á–∏
                const underplayed = players.filter(p => matchCount[p.id] < targetMatchesPerPlayer);
                
                while (underplayed.length >= 4) {
                    const selected = underplayed
                        .sort((a, b) => matchCount[a.id] - matchCount[b.id])
                        .slice(0, 4);
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Ç—É—Ä –¥–ª—è —ç—Ç–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
                    let freeTour = tour;
                    let foundFreeTour = false;
                    
                    for (let t = 1; t <= tour + 5; t++) {
                        const busy = selected.some(p => playerTourSchedule[p.id].includes(t));
                        if (!busy) {
                            freeTour = t;
                            foundFreeTour = true;
                            break;
                        }
                    }
                    
                    if (!foundFreeTour) {
                        freeTour = tour + 1;
                        tour = freeTour;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ç—á
                    matches.push({
                        id: matchId++,
                        team1: [selected[0].id, selected[1].id],
                        team2: [selected[2].id, selected[3].id],
                        score1: '',
                        score2: '',
                        completed: false,
                        tour: freeTour,
                        court: 1
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    selected.forEach(p => {
                        matchCount[p.id]++;
                        playerTourSchedule[p.id].push(freeTour);
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–µ–¥–æ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö
                    selected.forEach(p => {
                        const index = underplayed.findIndex(up => up.id === p.id);
                        if (index > -1) underplayed.splice(index, 1);
                    });
                }
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Ç—á–∏ –ø–æ —Ç—É—Ä–∞–º –∏ –∫–æ—Ä—Ç–∞–º
            matches.sort((a, b) => {
                if (a.tour !== b.tour) return a.tour - b.tour;
                return a.court - b.court;
            });
            
            // –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º ID –º–∞—Ç—á–µ–π –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            matches.forEach((match, index) => {
                match.id = index + 1;
            });
            
            console.log("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç—É—Ä–∞–º:");
            const tours = {};
            matches.forEach(match => {
                if (!tours[match.tour]) tours[match.tour] = [];
                tours[match.tour].push(match);
            });
            
            Object.keys(tours).forEach(tourNum => {
                console.log(`–¢—É—Ä ${tourNum}: ${tours[tourNum].length} –º–∞—Ç—á–µ–π`);
            });
            
            console.log("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ç—á–µ–π –Ω–∞ –∏–≥—Ä–æ–∫–∞:");
            players.forEach(p => {
                console.log(`${p.name}: ${matchCount[p.id]} –º–∞—Ç—á–µ–π`);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadFromStorage() {
            const saved = localStorage.getItem('americanoPadel');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    players = data.players || [];
                    matches = data.matches || [];
                    tournamentStarted = data.tournamentStarted || false;
                    courtCount = data.courtCount || 1;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä—Ç–æ–≤
                    if (document.getElementById('courtCount')) {
                        document.getElementById('courtCount').value = courtCount;
                    }
                    
                    updateUI();
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        function saveToStorage() {
            const data = {
                players,
                matches,
                tournamentStarted,
                courtCount,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('americanoPadel', JSON.stringify(data));
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞');
                return;
            }
            
            if (players.length >= 20) {
                alert('–ú–∞–∫—Å–∏–º—É–º 20 –∏–≥—Ä–æ–∫–æ–≤');
                return;
            }
            
            if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            players.push({
                id: Date.now() + Math.random(),
                name: name,
                scores: [],
                gameDiff: [],
                partners: [],
                total: 0,
                totalDiff: 0
            });
            
            nameInput.value = '';
            nameInput.focus();
            updateUI();
        }
        
        // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        function clearPlayers() {
            if (players.length === 0) return;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ (${players.length})?`)) {
                players = [];
                matches = [];
                tournamentStarted = false;
                courtCount = 1;
                document.getElementById('courtCount').value = 1;
                updateUI();
            }
        }
        
        // –ù–∞—á–∞–ª–æ —Ç—É—Ä–Ω–∏—Ä–∞
        function startTournament() {
            if (players.length < 4) {
                alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞');
                return;
            }
            
            courtCount = parseInt(document.getElementById('courtCount').value) || 1;
            
            players.forEach(p => {
                p.scores = [];
                p.gameDiff = [];
                p.partners = [];
                p.total = 0;
                p.totalDiff = 0;
            });
            
            generateBalancedMatchesWithTours();
            tournamentStarted = true;
            updateUI();
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –º–∞—Ç—á–∞
        function updateMatch(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) {
                console.error(`–ú–∞—Ç—á —Å ID ${matchId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –º–∞—Ç—á–∞ –ø–æ ID
            const matchCard = document.querySelector(`[data-match-id="${matchId}"]`);
            if (!matchCard) {
                console.error(`–ö–∞—Ä—Ç–æ—á–∫–∞ –º–∞—Ç—á–∞ —Å ID ${matchId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—è –≤–≤–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            const inputs = matchCard.querySelectorAll('.score-input-compact');
            if (inputs.length < 2) {
                console.error(`–ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è –º–∞—Ç—á–∞ ${matchId}`);
                return;
            }
            
            const score1 = inputs[0].value.trim();
            const score2 = inputs[1].value.trim();
            
            if (!score1 || !score2) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è —Å—á–µ—Ç–∞');
                return;
            }
            
            const s1 = parseInt(score1);
            const s2 = parseInt(score2);
            
            if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á–µ—Ç (—Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ –æ—Ç 0)');
                return;
            }
            
            if (match.completed) {
                resetMatchScores(match);
            }
            
            match.score1 = s1;
            match.score2 = s2;
            match.completed = true;
            
            updatePlayerScores(match);
            updateUI();
        }
        
        // –°–±—Ä–æ—Å –æ—á–∫–æ–≤ –º–∞—Ç—á–∞
        function resetMatchScores(match) {
            const team1Players = match.team1.map(id => players.find(p => p.id === id));
            const team2Players = match.team2.map(id => players.find(p => p.id === id));
            const matchIndex = matches.indexOf(match);
            
            [...team1Players, ...team2Players].forEach(player => {
                if (player) {
                    player.scores[matchIndex] = 0;
                    player.gameDiff[matchIndex] = 0;
                }
            });
            
            players.forEach(player => {
                player.total = player.scores.reduce((sum, score) => sum + (score || 0), 0);
                player.totalDiff = player.gameDiff.reduce((sum, diff) => sum + (diff || 0), 0);
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
        function updatePlayerScores(match) {
            const team1Players = match.team1.map(id => players.find(p => p.id === id));
            const team2Players = match.team2.map(id => players.find(p => p.id === id));
            
            const team1Won = match.score1 > match.score2;
            const gameDiff = Math.abs(match.score1 - match.score2);
            const matchIndex = matches.indexOf(match);
            
            team1Players.forEach(player => {
                if (player) {
                    const score = team1Won ? 2 : -2;
                    player.scores[matchIndex] = score;
                    player.gameDiff[matchIndex] = team1Won ? gameDiff : -gameDiff;
                    
                    const partner = team1Players.find(p => p.id !== player.id);
                    if (partner && !player.partners.includes(partner.name)) {
                        player.partners.push(partner.name);
                    }
                }
            });
            
            team2Players.forEach(player => {
                if (player) {
                    const score = !team1Won ? 2 : -2;
                    player.scores[matchIndex] = score;
                    player.gameDiff[matchIndex] = !team1Won ? gameDiff : -gameDiff;
                    
                    const partner = team2Players.find(p => p.id !== player.id);
                    if (partner && !player.partners.includes(partner.name)) {
                        player.partners.push(partner.name);
                    }
                }
            });
            
            players.forEach(player => {
                player.total = player.scores.reduce((sum, score) => sum + (score || 0), 0);
                player.totalDiff = player.gameDiff.reduce((sum, diff) => sum + (diff || 0), 0);
            });
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞
        function getPlayerName(id) {
            const player = players.find(p => p.id === id);
            return player ? player.name : '?';
        }
        
        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç—á–∞
        function openEditModal(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            editingMatchId = matchId;
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('modalError').textContent = '';
            
            document.getElementById('modalContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div style="text-align: center; margin-bottom: 12px; font-size: 0.9rem;">
                        <div style="font-weight: 600; color: var(--dark);">${getPlayerName(match.team1[0])} + ${getPlayerName(match.team1[1])}</div>
                        <div style="font-size: 0.8rem; color: var(--gray); margin: 4px 0;">vs</div>
                        <div style="font-weight: 600; color: var(--dark);">${getPlayerName(match.team2[0])} + ${getPlayerName(match.team2[1])}</div>
                        ${match.tour ? `<div style="font-size: 0.75rem; color: var(--gray); margin-top: 4px;">–¢—É—Ä ${match.tour}, –ö–æ—Ä—Ç ${match.court}</div>` : ''}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; max-width: 180px; margin: 0 auto;">
                        <input type="number" id="editScore1" min="0" max="10" 
                               value="${match.score1 || ''}" 
                               class="score-input-compact"
                               placeholder="0">
                        <div style="font-weight: 800; font-size: 1rem;">:</div>
                        <input type="number" id="editScore2" min="0" max="10" 
                               value="${match.score2 || ''}" 
                               class="score-input-compact"
                               placeholder="0">
                    </div>
                </div>
            `;
            
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editScore1').focus();
        }
        
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–∞—Ç—á–µ
        function saveEditedMatch() {
            if (editingMatchId === null) return;
            
            const score1 = document.getElementById('editScore1').value.trim();
            const score2 = document.getElementById('editScore2').value.trim();
            const errorDiv = document.getElementById('modalError');
            
            if (!score1 || !score2) {
                errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è —Å—á–µ—Ç–∞';
                errorDiv.style.display = 'block';
                return;
            }
            
            const s1 = parseInt(score1);
            const s2 = parseInt(score2);
            
            if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á–µ—Ç (—Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ –æ—Ç 0)';
                errorDiv.style.display = 'block';
                return;
            }
            
            const match = matches.find(m => m.id === editingMatchId);
            if (!match) return;
            
            if (match.completed) {
                resetMatchScores(match);
            }
            
            match.score1 = s1;
            match.score2 = s2;
            match.completed = true;
            
            updatePlayerScores(match);
            closeEditModal();
            updateUI();
        }
        
        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingMatchId = null;
        }
        
        // –£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞
        function clearMatchResult(matchId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞—Ç—á–∞? –≠—Ç–æ —Å–±—Ä–æ—Å–∏—Ç –æ—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.')) {
                return;
            }
            
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            if (!match.completed) {
                alert('–ú–∞—Ç—á –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω');
                return;
            }
            
            resetMatchScores(match);
            
            match.score1 = '';
            match.score2 = '';
            match.completed = false;
            
            updateUI();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
            document.getElementById('playersCount').textContent = players.length;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π
            const optimal = calculateOptimalMatches();
            document.getElementById('totalMatchesCalc').textContent = optimal.total;
            document.getElementById('matchesPerPlayer').textContent = optimal.perPlayer;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = players.map((p, index) => `
                <div class="player-card">
                    <div class="player-name">${p.name}</div>
                    <div class="player-number">${index + 1}</div>
                </div>
            `).join('');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—É—Ä–Ω–∏—Ä–∞
            const statusDiv = document.getElementById('tournamentStatus');
            const startBtn = document.getElementById('startBtn');
            
            if (players.length >= 4) {
                startBtn.disabled = false;
                if (!tournamentStarted) {
                    statusDiv.innerHTML = `
                        <div style="font-weight: 700; color: #065f46; margin-bottom: 4px;">
                            ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Å—Ç–∞—Ä—Ç—É
                        </div>
                        <div style="color: #065f46;">
                            –ò–≥—Ä–æ–∫–æ–≤: ${players.length} ‚Ä¢ –ú–∞—Ç—á–µ–π: ${optimal.total}
                        </div>
                    `;
                    statusDiv.style.background = '#d1fae5';
                    statusDiv.style.borderColor = '#10b981';
                } else {
                    const completed = matches.filter(m => m.completed).length;
                    const total = matches.length;
                    statusDiv.innerHTML = `
                        <div style="font-weight: 700; color: #7c3aed; margin-bottom: 4px;">
                            üèÅ –¢—É—Ä–Ω–∏—Ä –∏–¥–µ—Ç
                        </div>
                        <div style="color: #7c3aed;">
                            –ú–∞—Ç—á–µ–π: ${completed}/${total} –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                        </div>
                    `;
                    statusDiv.style.background = '#ede9fe';
                    statusDiv.style.borderColor = '#8b5cf6';
                }
            } else {
                startBtn.disabled = true;
                statusDiv.innerHTML = `
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 4px;">
                        ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    </div>
                    <div style="color: #92400e;">
                        –î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞
                    </div>
                `;
                statusDiv.style.background = '#fef3c7';
                statusDiv.style.borderColor = '#f59e0b';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('matchesPlayed').textContent = matches.filter(m => m.completed).length;
            document.getElementById('matchesTotal').textContent = matches.length;
            document.getElementById('courtsCount').textContent = courtCount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—É—Ä–∞—Ö
            const tourInfo = document.getElementById('tourInfo');
            if (tournamentStarted) {
                const tours = new Set(matches.map(m => m.tour));
                const completedTours = new Set(matches.filter(m => m.completed).map(m => m.tour));
                tourInfo.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                        <span>–¢—É—Ä–æ–≤: ${tours.size}</span>
                        <span>–ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ç—É—Ä–æ–≤: ${completedTours.size}</span>
                        <span>–ö–æ—Ä—Ç–æ–≤: ${courtCount}</span>
                    </div>
                `;
            } else {
                tourInfo.innerHTML = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –æ—á–∫–∏
            const scoresDiv = document.getElementById('currentScores');
            if (tournamentStarted && players.length > 0) {
                const sortedPlayers = [...players].sort((a, b) => b.total - a.total);
                scoresDiv.innerHTML = sortedPlayers.slice(0, 3).map(p => `
                    <div class="info-card">
                        <div style="font-size: 0.8rem; opacity: 0.9;">${p.name}</div>
                        <div class="info-value">${p.total > 0 ? '+' : ''}${p.total}</div>
                        <div style="font-size: 0.7rem;">${p.totalDiff > 0 ? '+' : ''}${p.totalDiff}</div>
                    </div>
                `).join('');
            } else {
                scoresDiv.innerHTML = `
                    <div class="info-card">
                        <div class="info-value">‚Äì</div>
                        <div class="info-label">–¢—É—Ä–Ω–∏—Ä –Ω–µ –Ω–∞—á–∞—Ç</div>
                    </div>
                `;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É –º–∞—Ç—á–µ–π —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ç—É—Ä–∞–º
            const matchesGrid = document.getElementById('matchesGrid');
            if (tournamentStarted && matches.length > 0) {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–∞—Ç—á–∏ –ø–æ —Ç—É—Ä–∞–º
                const matchesByTour = {};
                matches.forEach(match => {
                    if (!matchesByTour[match.tour]) {
                        matchesByTour[match.tour] = [];
                    }
                    matchesByTour[match.tour].push(match);
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—É—Ä—ã –ø–æ –Ω–æ–º–µ—Ä—É
                const sortedTours = Object.keys(matchesByTour).sort((a, b) => a - b);
                
                matchesGrid.innerHTML = sortedTours.map(tourNum => {
                    const tourMatches = matchesByTour[tourNum];
                    const completedInTour = tourMatches.filter(m => m.completed).length;
                    
                    return `
                        <div class="tour-container">
                            <div class="tour-header">
                                <div class="tour-title">
                                    üìã –¢—É—Ä ${tourNum}
                                    <span style="font-size: 0.85rem; opacity: 0.9;">
                                        (${completedInTour}/${tourMatches.length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ)
                                    </span>
                                </div>
                                ${courtCount > 1 ? `<div class="tour-court">${tourMatches.length} –º–∞—Ç—á–µ–π</div>` : ''}
                            </div>
                            
                            <div class="matches-container">
                                ${tourMatches.map(match => {
                                    const isCompleted = match.completed;
                                    const hasScore = match.score1 !== '' && match.score2 !== '';
                                    
                                    return `
                                        <div class="match-card ${isCompleted ? 'completed' : ''} court-${match.court}" data-match-id="${match.id}">
                                            <div class="match-header">
                                                <div class="match-id">
                                                    –ú–∞—Ç—á ${match.id}
                                                    ${courtCount > 1 ? `<span style="font-size: 0.7rem; color: var(--gray);"> (–ö–æ—Ä—Ç ${match.court})</span>` : ''}
                                                </div>
                                                ${isCompleted ? '<div class="match-status status-completed">‚úì</div>' : ''}
                                            </div>
                                            
                                            <div class="match-teams-compact">
                                                <div class="team-compact">
                                                    <div class="team-player-compact">${getPlayerName(match.team1[0])}</div>
                                                    <div class="team-player-compact">${getPlayerName(match.team1[1])}</div>
                                                </div>
                                                
                                                <div class="vs-compact">vs</div>
                                                
                                                <div class="team-compact">
                                                    <div class="team-player-compact">${getPlayerName(match.team2[0])}</div>
                                                    <div class="team-player-compact">${getPlayerName(match.team2[1])}</div>
                                                </div>
                                            </div>
                                            
                                            <div class="score-inputs-compact">
                                                <input type="number" min="0" max="10" 
                                                       value="${hasScore ? match.score1 : ''}" 
                                                       class="score-input-compact"
                                                       placeholder="0"
                                                       ${isCompleted ? 'readonly' : ''}
                                                       data-input="score1">
                                                <div class="score-separator-compact">:</div>
                                                <input type="number" min="0" max="10" 
                                                       value="${hasScore ? match.score2 : ''}" 
                                                       class="score-input-compact"
                                                       placeholder="0"
                                                       ${isCompleted ? 'readonly' : ''}
                                                       data-input="score2">
                                            </div>
                                            
                                            <div class="match-actions">
                                                ${!isCompleted ? `
                                                    <button onclick="updateMatch(${match.id})" 
                                                            class="btn btn-success btn-sm" style="flex: 1;">
                                                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                                    </button>
                                                ` : `
                                                    <button onclick="openEditModal(${match.id})" 
                                                            class="btn btn-outline" style="flex: 1;">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button onclick="clearMatchResult(${match.id})" 
                                                            class="btn btn-outline" style="flex: 1;">
                                                        ‚Ü∫
                                                    </button>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            } else if (tournamentStarted) {
                matchesGrid.innerHTML = `
                    <div class="loading">
                        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã—Ö –º–∞—Ç—á–µ–π...
                    </div>
                `;
            } else {
                matchesGrid.innerHTML = `
                    <div class="loading">
                        –ú–∞—Ç—á–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–Ω–∏—Ä–∞
                    </div>
                `;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
            const resultsBody = document.getElementById('resultsBody');
            if (tournamentStarted && players.length > 0) {
                const realMatchesPlayed = {};
                players.forEach(p => {
                    realMatchesPlayed[p.id] = p.scores.filter(s => s !== undefined && s !== null).length;
                });
                
                const matchCounts = Object.values(realMatchesPlayed);
                const minMatches = Math.min(...matchCounts);
                const maxMatches = Math.max(...matchCounts);
                
                const sortedPlayers = [...players].sort((a, b) => {
                    if (b.total !== a.total) return b.total - a.total;
                    return b.totalDiff - a.totalDiff;
                });
                
                resultsBody.innerHTML = sortedPlayers.map((p, index) => {
                    const isWinner = index === 0 && p.total > 0;
                    
                    const playedMatches = realMatchesPlayed[p.id];
                    const wonMatches = p.scores.filter(s => s > 0).length;
                    const lostMatches = p.scores.filter(s => s < 0).length;
                    
                    const partnersHtml = p.partners.length > 0 
                        ? p.partners.slice(0, 3).map(name => 
                            `<span class="badge badge-primary">${name}</span>`
                          ).join('')
                        : '‚Äì';
                    
                    return `
                        <tr ${isWinner ? 'class="winner"' : ''}>
                            <td><strong>${index + 1}</strong></td>
                            <td><strong>${p.name}</strong></td>
                            <td>
                                <div style="font-size: 0.8rem;">
                                    <span style="color: ${wonMatches > 0 ? 'var(--secondary)' : 'var(--gray)'}">${wonMatches}W</span>/
                                    <span style="color: ${lostMatches > 0 ? 'var(--danger)' : 'var(--gray)'}">${lostMatches}L</span>
                                    <br>
                                    <small style="color: var(--gray);">(${playedMatches})</small>
                                </div>
                            </td>
                            <td class="${p.total > 0 ? 'positive' : p.total < 0 ? 'negative' : ''}">
                                ${p.total > 0 ? '+' : ''}${p.total}
                            </td>
                            <td class="${p.totalDiff > 0 ? 'positive' : p.totalDiff < 0 ? 'negative' : ''}">
                                ${p.totalDiff > 0 ? '+' : ''}${p.totalDiff}
                            </td>
                            <td style="font-size: 0.8rem;">${partnersHtml}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: var(--gray);">
                            –ò—Ç–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
                        </td>
                    </tr>
                `;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            saveToStorage();
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('playerName')?.focus();
        }
        
        // –°–±—Ä–æ—Å —Ç—É—Ä–Ω–∏—Ä–∞
        function resetTournament() {
            if (!tournamentStarted && matches.length === 0) {
                alert('–¢—É—Ä–Ω–∏—Ä –µ—â–µ –Ω–µ –Ω–∞—á–∞—Ç –∏–ª–∏ —É–∂–µ —Å–±—Ä–æ—à–µ–Ω');
                return;
            }
            
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—É—Ä–Ω–∏—Ä? –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                matches = [];
                tournamentStarted = false;
                courtCount = 1;
                document.getElementById('courtCount').value = 1;
                
                players.forEach(p => {
                    p.scores = [];
                    p.gameDiff = [];
                    p.partners = [];
                    p.total = 0;
                    p.totalDiff = 0;
                });
                
                updateUI();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadFromStorage();
        updateUI();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('playerName')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
        document.getElementById('editModal')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('editModal').style.display === 'flex') {
                closeEditModal();
            }
        });
    </script>
</body>
</html>
